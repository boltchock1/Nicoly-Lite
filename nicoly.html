<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nicoly Lite</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@latest"></script>
    <script src="https://unpkg.com/compromise"></script>
    <style>
        body { font-family: Arial; max-width: 600px; margin: 20px auto; }
        .container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
        button { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        #resposta { background: #e9ecef; padding: 10px; margin: 10px 0; }
        .feedback { margin-top: 10px; }
        .feedback button { margin-right: 5px; }
    </style>
</head>
<body>
    <h2>Nicoly Lite</h2>
    
    <div class="container">
        <input type="text" id="pergunta" placeholder="Digite sua pergunta...">
        <button onclick="enviarPergunta()">Enviar</button>
        <div id="resposta">Carregando...</div>
        <div class="feedback">
            <button onclick="avaliarResposta('positivo')">üëç</button>
            <button onclick="avaliarResposta('negativo')">üëé</button>
        </div>
    </div>

    <div class="container">
        <h4>Adicionar Nova Resposta</h4>
        <input type="text" id="novaPergunta" placeholder="Pergunta...">
        <textarea id="novaResposta" placeholder="Resposta..."></textarea>
        <button onclick="adicionarRegra()">Salvar</button>
    </div>

    <div class="container">
        <h4>Adicionar Informa√ß√£o Personalizada (Texto Longo)</h4>
        <textarea id="infoPersonalizada" placeholder="Escreva informa√ß√µes personalizadas para a Nicoly..."></textarea>
        <button onclick="adicionarInformacao()">Salvar Informa√ß√£o</button>
    </div>

    <script>
// ------------ [INICIALIZA√á√ÉO] ------------
let encoder;
const regras = JSON.parse(localStorage.getItem('regras')) || {
    "oi": ["Ol√°! Como posso ajudar?", "Oi! Tudo bem?", "E a√≠, como vai?"],
    "qual seu nome": ["Sou a Nicoly Lite!", "Me chamo Nicoly Lite!", "Pode me chamar de Nicoly!"],
    "wiki": "(Modo Wikipedia ativado)"
};
const informacoesPersonalizadas = JSON.parse(localStorage.getItem('informacoesPersonalizadas')) || [];
let contexto = []; // Mem√≥ria de curto prazo
let ultimaResposta = null; // Armazena a √∫ltima resposta para feedback

// ------------ [FUN√á√ïES PRINCIPAIS] ------------
async function loadModel() {
    encoder = await use.load();
    document.getElementById('resposta').innerText = "Pronta para conversar!";
}

async function buscarWikipedia(termo) {
    try {
        const response = await fetch(`https://pt.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&titles=${encodeURIComponent(termo)}&exsentences=2&exlimit=1&explaintext=1`);
        const data = await response.json();
        const pagina = data.query.pages[Object.keys(data.query.pages)[0]];
        return pagina.extract?.split(". ").slice(0, 2).join(". ") || "N√£o encontrei informa√ß√µes.";
    } catch (e) {
        return "Erro na busca.";
    }
}

async function calcularEmbedding(texto) {
    const embedding = await encoder.embed([texto]);
    return embedding.arraySync()[0];
}

function dividirTextoSentencas(texto) {
    // Divide o texto em senten√ßas usando pontua√ß√£o
    return texto.split(/[.!?]/).map(s => s.trim()).filter(s => s.length > 0);
}

async function adicionarRegra() {
    const pergunta = document.getElementById('novaPergunta').value.toLowerCase();
    const resposta = document.getElementById('novaResposta').value;

    if (pergunta && resposta) {
        regras[pergunta] = resposta.split(";"); // Permite m√∫ltiplas respostas
        localStorage.setItem('regras', JSON.stringify(regras));
        alert("Resposta salva!");
    }
}

async function adicionarInformacao() {
    const texto = document.getElementById('infoPersonalizada').value.trim();

    if (texto) {
        const sentencas = dividirTextoSentencas(texto);
        for (const sentenca of sentencas) {
            const embedding = await calcularEmbedding(sentenca);
            informacoesPersonalizadas.push({ texto: sentenca, embedding });
        }
        localStorage.setItem('informacoesPersonalizadas', JSON.stringify(informacoesPersonalizadas));
        alert("Informa√ß√£o salva e treinada!");
    } else {
        alert("Por favor, insira um texto.");
    }
}

function calcularSimilaridade(embedding1, embedding2) {
    // Calcula a similaridade cosseno entre dois embeddings
    const produtoEscalar = embedding1.reduce((sum, val, i) => sum + val * embedding2[i], 0);
    const magnitude1 = Math.sqrt(embedding1.reduce((sum, val) => sum + val * val, 0));
    const magnitude2 = Math.sqrt(embedding2.reduce((sum, val) => sum + val * val, 0));
    return produtoEscalar / (magnitude1 * magnitude2);
}

async function encontrarResposta(pergunta) {
    // Verifica regras salvas
    for (const [key, value] of Object.entries(regras)) {
        if (pergunta.toLowerCase().includes(key)) {
            return Array.isArray(value) ? value[Math.floor(Math.random() * value.length)] : value;
        }
    }

    // Verifica informa√ß√µes personalizadas
    for (const info of informacoesPersonalizadas) {
        if (pergunta.toLowerCase().includes(info.texto)) return info.texto;
    }

    // Busca na Wikipedia se n√£o encontrar
    const respostaWiki = await buscarWikipedia(pergunta);
    if (respostaWiki !== "N√£o encontrei informa√ß√µes.") {
        return respostaWiki;
    }

    // Respostas padr√£o para perguntas comuns
    if (pergunta.toLowerCase().includes("descobriu o brasil")) {
        return "O Brasil foi descoberto pelos portugueses em 22 de abril de 1500, liderados por Pedro √Ålvares Cabral.";
    }

    return "N√£o entendi. Pode reformular?";
}

async function enviarPergunta() {
    const pergunta = document.getElementById('pergunta').value;
    const resposta = await encontrarResposta(pergunta);
    
    document.getElementById('resposta').innerText = resposta;
    document.getElementById('pergunta').value = "";

    // Salva hist√≥rico
    const historico = JSON.parse(localStorage.getItem('historico') || "[]");
    historico.push({ pergunta, resposta });
    localStorage.setItem('historico', JSON.stringify(historico));

    // Armazena a √∫ltima resposta para feedback
    ultimaResposta = { pergunta, resposta };
}

function avaliarResposta(tipo) {
    if (!ultimaResposta) {
        alert("Nenhuma resposta para avaliar.");
        return;
    }

    const feedback = {
        pergunta: ultimaResposta.pergunta,
        resposta: ultimaResposta.resposta,
        tipo: tipo
    };

    // Salva o feedback no localStorage
    const feedbacks = JSON.parse(localStorage.getItem('feedbacks') || []);
    feedbacks.push(feedback);
    localStorage.setItem('feedbacks', JSON.stringify(feedbacks));

    alert(`Feedback ${tipo} registrado!`);
}

// Inicia o modelo
loadModel();
    </script>
</body>
</html>